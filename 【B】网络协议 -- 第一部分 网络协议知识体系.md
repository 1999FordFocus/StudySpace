## 【B】网络协议 -- 第一部分: 网络协议知识体系

> 昔日戏言身后意，今朝都到眼前来。衣裳已施行看尽，针线犹存未忍开。
>
> 尚想旧情怜婢仆，也曾因梦送钱财。诚知此恨人人有，贫贱夫妻百事哀。
>
> -- 《遣悲怀》唐·元稹



### 知识大纲







### 基础知识

**协议三要素 ：**

- 语法 
- 语义
- 顺序



#### 一次网络通信的大致流程

​	要访问一个URL，**应用层**首先要通过地址薄协议DNS或者HTTPDNS，最终得到目标 ip 地址。得到地址后，根据HTTP或者HTTPS协议封装请求包。通过Socket编程将包从应用层传到传输层。**传输层**（添加TCP头）有两种协议TCP、UDP。TCP能够保证包到达目的地，如果不能到达，就会重新发送。接下来包交给**网络层**，**网络层**（添加ip头）协议是 ip 协议。 操作系统启动时会被DHCP协议配置IP地址以及默认的网关的IP地址 192.168.1.1，客户端通过本地局域网广播询问网关mac地址，数据链路层 ARP（地址解析协议）提供ip地址解析成MAC地址服务。ip包从客户端发送MAC层（数据链路层第一子层，添加MAC头），继而通过数据链路层网关的MAC地址，再将包发到网关。网关根据路由表进行跳转，网关间通过路由协议OSPF和BGP沟通。

​	最后一个网关知道这个网络包就是要去这个局域网的，于是拿着目标IP通过ARP协议大喊一声这是谁？ 目标服务器就会给网关回复一个MAC地址。 然后网络包在最后那个网关修改目标的MAC地址，通过这个MAC地址，网络包找到了目标服务器。目标服务器发现MAC地址对上了，取下MAC头来，发送给操作系统网络层，网络层取下IP头，然后交给传输层即TCP层。在这一层里，对于收到的每个包，都会有一个回复，报个平安说包收到了。TCP 头中有目标端口号，可以找到服务端正在监听这个端口号的进程，于是服务端就接收到了HTTP请求包的内容。

#### ![img](.\images\5985d6d430e1b1d3f165bf0f916ed954.jpg)

自己写程序简单实现网络通信模型：

![img](.\images\5c00f6e610f533d17fb4ad7decacc776.jpg)









#### 网络分层的意义

​		只要是在网络上跑的包，都是完整的。可以有下层没上层，绝不可能有上层没下层。对于TCP协议来说，三次握手也好，重试也好，只要想发出去包，就要有IP层和MAC层，不然是发不出去的。

​		Linux 默认的逻辑是，如果这是一个跨网段的调用，它便不会直接将包发送到网络上，而是企图将包发送到网关。





#### IP地址的分配 -- 动态主机配置协议（DHCP）

​	新来的客户机只知道自己mac地址而已，它想要申请一个ip地址，所以使用 0.0.0.0为源ip地址、255.255.255.255为目标ip地址进行广播，这个广播包封装了UDP，UDP封装了BOOTP。

​	![image-20201022141422500](.\images\image-20201022141422500.png)

DHCP server 接收到之后，以客户机mac地址为唯一识别符 ， 通过广播下发DHCP Offer: 

![image-20201022141126092](.\images\image-20201022141126092.png)



客户端从多个Offer中选一个，并发送DHCP request广播数据包表示接收租约。

DHCP Servier 会广播返回给客户机DHCP ACK消息包，确认其加入并将ip地址合法租用信息和配置信息一并放入。







### 网络模型 -- 第二层（数据链路层）到第三层（网络层）



#### ARP 协议

​	在一个局域网里边，知道了ip地址不知道mac地址怎么办呢？ 靠“吼” 。广而告之，发送一个广播包，谁是这个 IP 谁来回答。

![image-20201022143855920](.\images\image-20201022143855920.png)

​	广播报文结构：

![image-20201022144051361](.\images\image-20201022144051361.png)

​	避免每次都用 ARP 请求，机器本地也会进行 ARP 缓存。当然机器会不断地上线下线，IP 也可能会变，所以 ARP 的 MAC 地址缓存过一段时间就会过期。



#### 动态路由协议

1. **基于链路状态路由算法的OSPF**

   

   

   

   

   

   

   

   

   

2. **基于距离矢量路由算法的BGP**





### 网络模型 -- 传输层

#### UDP 协议



#### TCP协议



#### 套接字Socket



### 网络模型 -- 应用层

#### HTTP 协议



#### HTTPS协议



#### 流媒体协议









### 数据中心

#### DNS与HTTPDNS

​	



#### CDN

​	就近配送



#### VPN （Virtual Private Network，虚拟专用网）

​	

















### 参考资源







